<style>
    .player-container {
        background: black;
        width: 100%;
        aspect-ratio: 16/9;
        position: relative;
    }

    video {
        width: 100%;
        height: 100%;
        display: block;
        background: black;
    }

    .play-layout {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .play-title {
        font-size: 1.2rem;
        font-weight: 700;
        margin: 15px 0 12px;
        line-height: 1.4;
    }

    .uploader-strip {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--surface);
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .uploader-strip .name {
        flex: 1;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .sub-btn {
        background: white;
        color: black;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
    }

    .action-row {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 10px;
        margin-bottom: 20px;
        scrollbar-width: none;
    }

    .action-row::-webkit-scrollbar {
        display: none;
    }

    .action-btn {
        background: var(--surface);
        padding: 8px 18px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        white-space: nowrap;
        cursor: pointer;
        transition: background 0.2s;
    }

    .action-btn:hover {
        background: var(--surface-accent);
    }

    /* Desktop Adjustments */
    @media (min-width: 992px) {
        .play-layout {
            flex-direction: row;
            align-items: flex-start;
            gap: 30px;
        }

        .play-main-col {
            flex: 2.5;
            min-width: 0;
        }

        .play-side-col {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.02);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .play-title {
            font-size: 1.5rem;
        }
    }
</style>

<div class="play-layout">
    <div class="play-main-col">
        <div class="player-container">
            <video id="mainPlayer" controls autoplay playsinline preload="auto">
                <source src="<%= stream_url %>" type="video/mp4">
                Browser Anda tidak mendukung pemutaran video.
            </video>
        </div>

        <h1 class="play-title">
            <%= title %>
        </h1>

        <div class="action-row">
            <div class="action-btn" id="prevBtn" onclick="playPrevious()" style="opacity: 0.5;">
                <i class="fas fa-step-backward"></i>
                <span>Prev</span>
            </div>
            <div class="action-btn" id="nextBtn" onclick="playNext()" style="opacity: 0.5;">
                <i class="fas fa-step-forward"></i>
                <span>Next</span>
            </div>
            <div class="action-btn">
                <i class="fas fa-thumbs-up"></i>
                <span>Suka</span>
            </div>
            <div class="action-btn">
                <i class="fas fa-share"></i>
                <span>Bagikan</span>
            </div>
            <div class="action-btn" onclick="minimizePlayer()">
                <i class="fas fa-compress-alt"></i>
                <span>Minimize</span>
            </div>
            <div class="action-btn" onclick="addToPlaylist()">
                <i class="fas fa-plus"></i>
                <span>Simpan</span>
            </div>
            <div class="action-btn">
                <i class="fas fa-download"></i>
                <span>Unduh</span>
            </div>
        </div>
    </div>

    <script>
        // Navigation data
        const relatedVideos = '<% - JSON.stringify(locals.relatedVideos || []) %>';
        const currentVideoId = '<%= id %>';
        let currentIndex = -1;

        // Find current video position in related videos
        function updateNavigationState() {
            // Current video is not in the list, so we treat related as "next" videos
            const hasPrev = false; // No previous since current video is being played
            const hasNext = relatedVideos.length > 0;

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) {
                prevBtn.style.opacity = hasPrev ? '1' : '0.5';
                prevBtn.style.cursor = hasPrev ? 'pointer' : 'not-allowed';
            }
            if (nextBtn) {
                nextBtn.style.opacity = hasNext ? '1' : '0.5';
                nextBtn.style.cursor = hasNext ? 'pointer' : 'not-allowed';
            }
        }

        function playPrevious() {
            // Since current video is the one being played, there's no previous
            // But we could implement going back in browser history
            if (window.history.length > 1) {
                window.history.back();
            }
        }

        function playNext() {
            if (relatedVideos.length > 0) {
                navigate('/play?v=' + relatedVideos[0].id);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Only trigger if not typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                playPrevious();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                playNext();
            }
        });

        // Auto-play next video when current ends
        const player = document.getElementById('mainPlayer');
        if (player) {
            player.addEventListener('ended', function () {
                if (relatedVideos.length > 0) {
                    setTimeout(() => playNext(), 1000); // 1 second delay
                }
            });
        }

        // Initialize navigation state
        updateNavigationState();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const player = document.getElementById('mainPlayer');
            const urlParams = new URLSearchParams(window.location.search);
            const timeParam = urlParams.get('t');

            // Resume from URL param or localStorage
            if (timeParam) {
                player.currentTime = parseFloat(timeParam);
            } else {
                const savedTime = localStorage.getItem('videoTime_<%= id %>');
                if (savedTime) player.currentTime = parseFloat(savedTime);
            }

            // Save time periodically
            player.ontimeupdate = () => {
                localStorage.setItem('videoTime_<%= id %>', player.currentTime);
            };
        });

        function minimizePlayer() {
            const player = document.getElementById('mainPlayer');
            const id = '<%= id %>';

            // Save current time before leaving
            localStorage.setItem('videoTime_' + id, player.currentTime);

            const prev = document.referrer || '/';
            const url = new URL(prev, window.location.origin);
            url.searchParams.set('min', id);
            location.href = url.pathname + url.search;
        }
    </script>

    <div class="play-side-col">
        <div class="uploader-strip">
            <div class="channel-avatar"
                style="width: 40px; height: 40px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold;">
                <%= (uploader || 'C' ).charAt(0).toUpperCase() %>
            </div>
            <div class="name">
                <%= uploader %>
            </div>
            <button class="sub-btn" onclick="toggleSub('<%= channel_id %>', '<%= uploader %>')">Subscribe</button>
        </div>

        <div style="border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
            <h3 style="font-size: 0.95rem; margin-bottom: 15px;">Video Terkait</h3>
            <% if (locals.relatedVideos && relatedVideos.length> 0) { %>
                <% relatedVideos.forEach(function(video) { %>
                    <div onclick="navigate('/play?v=<%= video.id %>')"
                        style="display: flex; gap: 10px; margin-bottom: 15px; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.05)'"
                        onmouseout="this.style.background='transparent'">
                        <img src="<%= video.thumbnail %>"
                            style="width: 120px; height: 68px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-size: 0.85rem; margin: 0 0 4px 0; font-weight: 600; line-height: 1.3; 
                                       overflow: hidden; text-overflow: ellipsis; display: -webkit-box; 
                                       -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;">
                                <%= video.title %>
                            </h4>
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin: 0;">
                                <%= video.uploader %>
                            </p>
                            <% if (video.views) { %>
                                <p style="font-size: 0.7rem; color: var(--text-dim); margin: 2px 0 0 0;">
                                    <% let viewText='' ; if (video.views> 1000000) viewText =
                                        (video.views/1000000).toFixed(1) + 'jt';
                                        else if (video.views > 1000) viewText = (video.views/1000).toFixed(0) + 'rb';
                                        else viewText = video.views;
                                        viewText += ' x tonton';
                                        %>
                                        <%= viewText %>
                                </p>
                                <% } %>
                        </div>
                    </div>
                    <% }); %>
                        <% } else { %>
                            <p style="font-size: 0.8rem; color: var(--text-dim); text-align: center; padding: 20px;">
                                Belum ada video terkait
                            </p>
                            <% } %>
        </div>
    </div>
</div>

<script>
    async function toggleSub(cid, uploader) {
        await fetch('/toggle_subscription', {
            method: 'POST',
            body: JSON.stringify({ channel_id: cid, uploader }),
            headers: { 'Content-Type': 'application/json' }
        });
        location.reload();
    }
</script>

<script>
    async function addToPlaylist() {
        const res = await fetch('/api/playlists');
        const playlists = await res.json();

        let html = '';
        if (Object.keys(playlists).length === 0) {
            html = '<p style="padding: 20px; text-align: center; opacity: 0.5;">Belum ada playlist.</p>';
        } else {
            for (const name in playlists) {
                html += `
                    <div class="playlist-select-item" onclick="saveToPlaylist('${name}')">
                        <i class="fas fa-list-ul"></i>
                        <span>${name}</span>
                    </div>
                `;
            }
        }

        document.getElementById('playlistModalList').innerHTML = html;
        document.getElementById('playlistModal').classList.add('show');
        document.getElementById('modalBackdrop').classList.add('show');
    }

    async function saveToPlaylist(playlistName) {
        const video = {
            id: '<%= id %>',
            title: '<%= title %>',
            uploader: '<%= uploader %>',
            thumbnail: '<%= thumbnail %>',
            duration: '<%= duration %>',
            views: '<%= views %>',
            channel_id: '<%= channel_id %>'
        };

        const res = await fetch('/add_to_playlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ playlistName, video })
        });

        if (res.ok) {
            hideModal();
            alert('Berhasil disimpan ke ' + playlistName);
        }
    }

    function hideModal() {
        document.getElementById('playlistModal').classList.remove('show');
        document.getElementById('modalBackdrop').classList.remove('show');
    }
</script>

<!-- Playlist Modal -->
<div id="modalBackdrop" onclick="hideModal()"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; backdrop-filter: blur(5px);">
</div>
<div id="playlistModal"
    style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: var(--surface); border-radius: 24px; z-index: 2001; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
    <div
        style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 1.1rem;">Simpan ke...</h3>
        <i class="fas fa-times" onclick="hideModal()" style="cursor: pointer; opacity: 0.5;"></i>
    </div>
    <div id="playlistModalList" style="max-height: 300px; overflow-y: auto; padding: 10px;"></div>
</div>

<style>
    .playlist-select-item {
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.2s;
        color: var(--text-dim);
    }

    .playlist-select-item:hover {
        background: var(--surface-accent);
        color: white;
    }

    .playlist-select-item i {
        color: var(--primary);
    }

    /* Modal fade transitions */
    #modalBackdrop,
    #playlistModal {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        pointer-events: none;
    }

    #modalBackdrop.show,
    #playlistModal.show {
        display: block !important;
        opacity: 1;
        pointer-events: auto;
    }
</style>